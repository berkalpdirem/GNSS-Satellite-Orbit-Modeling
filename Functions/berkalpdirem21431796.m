format long g
c=2.99792458*10^8;   %Velocity of light for WGS84
disp('For ionphere model and using TGD :1')
disp('Without ionphere model and using TGD :0')
selection=input('Please select the following which path(1 or 0):');
%% Calculate calculation epoch:
%calculation eppoch 21780 It's equal 6.03
calculation_epoch=(2+1+4+3+1+7+9+6)*660;
year=2020;
mounth=4;
day=1;
sec=calculation_epoch;
%% Mersin station parameters:
%Approximate coordinates:
R0rcv=[4239146.6414;2886967.1245;3778874.4800];

%My Satallites:G04,G05,G07,G08,G09,G13,G27,G28,G30 Also them C1 measurements:
Prn_c1=[04 25773566.953;
        05 21776813.343;
        07 21547971.370;
        08 23951274.268;
        09 22708719.035;
        13 23309733.958;
        27 25421090.002;
        28 20930571.293;
        30 20619012.542];
%% Navigation Message Parameters:
%Alpha and Beta from navigation message:
ION_ALPHA=[0.1118D-07  0.7451D-08 -0.5960D-07 -0.5960D-07];    
ION_BETA =[0.9011D+05  0.1638D+05 -0.1966D+06 -0.6554D+05];

%Clock corrections with their related epochs(06.00)
RC04=[21600 -0.701169483364D-04 -0.522959453519D-11 0.000000000000D+00];
RC05=[21600 -0.100834295154D-04 -0.682121026330D-12 0.000000000000D+00];
RC07=[21600 -0.248607713729D-03 -0.852651282912D-11 0.000000000000D+00];
RC08=[21600 -0.291154719889D-04 -0.136424205266D-11 0.000000000000D+00];
RC09=[21600 -0.188608188182D-03 -0.795807864051D-11 0.000000000000D+00];
RC13=[21600 -0.138720497489D-05  0.295585778076D-11 0.000000000000D+00];
RC27=[21600 -0.254543498158D-03 -0.105728759081D-10 0.000000000000D+00];
RC28=[21600  0.728725921363D-03 -0.284217094304D-11 0.000000000000D+00];
RC30=[21600 -0.188396312296D-03 -0.852651282912D-11 0.000000000000D+00];

Relatedepoch_Clockcorrections={RC04 RC05 RC07 RC08 RC09 RC13 RC27 RC28 RC30};


%Satallite parameters from navigation message
G04=[0.220000000000D+03  0.353125000000D+01  0.472162524607D-08 -0.184883917477D+00;
     0.372529029846D-08  0.649514026008D-03  0.751391053200D-05  0.515369906425D+04;
     0.280800000000D+06 -0.409781932831D-07 -0.877786718312D-01 -0.111758708954D-07;
     0.960339026067D+00  0.231000000000D+03 -0.263921882293D+01 -0.802140555231D-08;
    -0.689314426998D-10  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00;
     0.200000000000D+01  0.000000000000D+00 -0.419095158577D-08  0.220000000000D+03;
     0.273618000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];

G05=[0.740000000000D+02 -0.392500000000D+02  0.490341853278D-08  0.157969803555D+01
    -0.195391476154D-05  0.579916324932D-02  0.901892781258D-05  0.515362991524D+04
     0.280800000000D+06 -0.156462192535D-06 -0.119751473670D+01  0.409781932831D-07
     0.951875363258D+00  0.204406250000D+03  0.786453237471D+00 -0.815533970263D-08
     0.208580116771D-09  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00
     0.200000000000D+01  0.000000000000D+00 -0.111758708954D-07  0.740000000000D+02
     0.273618000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];

G07=[0.114000000000D+03  0.220625000000D+02  0.457376194411D-08 -0.208631828876D+01;
     0.996515154839D-06  0.135306593729D-01  0.819191336632D-05  0.515367783165D+04;
     0.280800000000D+06  0.242143869400D-07  0.938869946925D+00 -0.171363353729D-06;
     0.953538442178D+00  0.216812500000D+03 -0.241010949044D+01 -0.780639659632D-08;
    -0.228223792151D-09  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00;
     0.200000000000D+01  0.000000000000D+00 -0.111758708954D-07  0.114000000000D+03;
     0.273642000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];
 
G08=[0.270000000000D+02  0.243437500000D+02  0.434160941689D-08  0.973475120483D+00;
     0.124610960484D-05  0.531830638647D-02  0.365450978279D-05  0.515364939499D+04;
     0.280800000000D+06  0.651925802231D-07  0.300671301840D+01  0.596046447754D-07;
     0.970104557229D+00  0.312718750000D+03 -0.123474030960D+00 -0.823820029697D-08;
     0.102147111980D-09  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00;
     0.200000000000D+01  0.000000000000D+00  0.512227416039D-08  0.270000000000D+02;
     0.273618000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];
 
G09=[0.550000000000D+02  0.465625000000D+01  0.488020328006D-08  0.117005466717D+01;
     0.633299350738D-07  0.161752023269D-02  0.753998756409D-05  0.515375662231D+04;
     0.280800000000D+06 -0.670552253723D-07 -0.135228163722D+00 -0.223517417908D-07;
     0.953029845541D+00  0.228218750000D+03  0.180147832548D+01 -0.810890919719D-08;
    -0.821462788651D-11  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00;
     0.200000000000D+01  0.000000000000D+00  0.139698386192D-08  0.550000000000D+02;
     0.273618000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];
 
G13=[0.520000000000D+02  0.306250000000D+01  0.464447917549D-08  0.137382241836D-01;
     0.284984707832D-06  0.412526482250D-02  0.746920704842D-05  0.515365618706D+04;
     0.280800000000D+06  0.558793544769D-08  0.671653924511D-02 -0.149011611938D-07;
     0.968253139310D+00  0.236437500000D+03  0.112338521782D+01 -0.809247994142D-08;
    -0.133576992589D-09  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00;
     0.200000000000D+01  0.000000000000D+00 -0.111758708954D-07  0.520000000000D+02;
     0.273618000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];
 
G27=[0.910000000000D+02  0.229687500000D+02  0.420553232016D-08  0.803303275663D+00;
     0.111199915409D-05  0.812731194310D-02  0.388361513615D-05  0.515366350365D+04;
     0.280800000000D+06 -0.651925802231D-07  0.302054176795D+01  0.875443220139D-07;
     0.978514336376D+00  0.314500000000D+03  0.528866743114D+00 -0.822177104119D-08;
     0.442875590403D-10  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00;
     0.200000000000D+01  0.000000000000D+00  0.139698386192D-08  0.910000000000D+02;
     0.278276000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];
 
G28=[0.150000000000D+02  0.620312500000D+02  0.400230956940D-08  0.152993679955D+01;
     0.306218862534D-05  0.184999975609D-01  0.731647014618D-05  0.515366632271D+04;
     0.280800000000D+06  0.189989805222D-06  0.206725050041D+01 -0.467523932457D-06;
     0.978057355878D+00  0.244062500000D+03 -0.141139056572D+01 -0.783354058412D-08;
     0.532165023952D-10  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00;
     0.200000000000D+01  0.000000000000D+00 -0.111758708954D-07  0.150000000000D+02;
     0.273618000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];
 
G30=[0.530000000000D+02  0.224062500000D+02  0.495984945478D-08 -0.209686055628D+01;
     0.105239450932D-05  0.441883318126D-02  0.838190317154D-05  0.515366695785D+04;
     0.280800000000D+06 -0.726431608200D-07  0.962388258305D+00 -0.111758708954D-07;
     0.938859526559D+00  0.206687500000D+03 -0.291635569598D+01 -0.814462497061D-08;
    -0.274654297597D-09  0.100000000000D+01  0.209900000000D+04  0.000000000000D+00;
     0.200000000000D+01  0.000000000000D+00  0.372529029846D-08  0.530000000000D+02;
     0.273618000000D+06  0.400000000000D+01  0.000000000000D+00  0.000000000000D+00];
 
sat_paramets={G04 G05 G07 G08 G09 G13 G27 G28 G30};

 %% Calculation part:
%Creating empty arrays and matrix for saving

%They will be result 
cdtrec=0;
x0=0;
y0=0;
z0=0;
%They will fill
Satpositon={};
D={};
L=[];
A=[];

for i=1:length(sat_paramets)
    %Calling related function for calcultions
    D{i}=drm(calculation_epoch,Prn_c1(i,2),Relatedepoch_Clockcorrections{i},sat_paramets{i},R0rcv,ION_ALPHA,ION_BETA,sat_paramets{i}(6,3),selection);
    Satpositon{i}=new_satpos(calculation_epoch,Prn_c1(i,2),Relatedepoch_Clockcorrections{i},sat_paramets{i},R0rcv);
    %Creating least square matrix<
    p0=sqrt((Satpositon{i}(1)-x0)^2+(Satpositon{i}(2)-y0)^2+(Satpositon{i}(3)-z0)^2)  ;
    L=[L;[Prn_c1(i,2)-p0-D{i}]];
    A=[A;[(x0-Satpositon{i}(1))/p0 (y0-Satpositon{i}(2))/p0 (z0-Satpositon{i}(3))/p0 1]];
end

%Find unknowns from least square
X = A\L;
%X=((A'*A)^-1)*A'*L;
dx=X(1);
dy=X(2);
dz=X(3);
cdtrcv=X(4);
%Start an iteration for find my unknown parameters
while  abs(dx)>10^-3 && abs(dy)>10^-3 && abs(dz)>10^-3
    x0=dx+x0;
    y0=dy+y0;
    z0=dz+z0;   
    L=[];
    A=[];      
    for i=1:length(sat_paramets)
        p0=sqrt((Satpositon{i}(1)-x0)^2+(Satpositon{i}(2)-y0)^2+(Satpositon{i}(3)-z0)^2);  
        L=[L;[Prn_c1(i,2)-p0-D{i}]];
        A=[A;[(x0-Satpositon{i}(1))/p0 (y0-Satpositon{i}(2))/p0 (z0-Satpositon{i}(3))/p0 1]]  ; 
    end
    %X=((A'*A)^-1)*A'*L;
    X = A\L;
    dx=X(1);
    dy=X(2);
    dz=X(3);
    cdtrec=X(4);  
end
%Comparison my result with approximate coordinate of receiver
IGScor=[4239149.23905405 2886968.03012480 3778877.17820202];
Comparison=sqrt((x0-IGScor(1))^2+(y0-IGScor(2))^2+(z0-IGScor(3))^2);
%% Display part:
disp('X coordinate:');
disp(x0)
disp('Y coordinate:');
disp(y0)
disp('Z coordinate:');
disp(z0)
disp('Receiver Clcok Error:');
disp(cdtrcv/c)
disp('-----------------------------------------------------------')
disp('Comparison my result with IGS coordinate of receiver:')
disp(Comparison)